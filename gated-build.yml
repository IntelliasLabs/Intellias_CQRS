pool:
  name: Default
  demands:
  - msbuild
  - visualstudio
  - java

#Your build pipeline references an undefined variable named ‘Parameters.RestoreBuildProjects’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references the ‘BuildPlatform’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references an undefined variable named ‘Parameters.TestProjects’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971

steps:
- task: DotNetCoreCLI@2
  displayName: Restore
  inputs:
    command: restore
    projects: '$(Parameters.RestoreBuildProjects)'

- task: SonarSource.sonarcloud.14d9cde6-c1da-4d55-aa01-2965cd301255.SonarCloudPrepare@1
  displayName: 'Prepare Sonar Analysis'
  inputs:
    SonarCloud: IntelliasSonar
    organization: intellias
    projectKey: 'Intellias-CQRS'
    projectName: 'Intellias-CQRS'
    extraProperties: |
     sonar.cs.vscoveragexml.reportsPaths="$(Agent.TempDirectory)\VisualStudio.coveragexml"
     sonar.cs.vstest.reportsPaths="$(Agent.TempDirectory)\*.trx"

- task: VSBuild@1
  displayName: Build
  inputs:
    vsVersion: 15.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    maximumCpuCount: true
    msbuildArchitecture: x64

- task: DotNetCoreCLI@2
  displayName: Test
  inputs:
    command: test
    projects: '$(Parameters.TestProjects)'
    arguments: '--configuration $(BuildConfiguration) --collect "Code Coverage" --settings Intellias.CQRS\test.runsettings'

- powershell: |
   $file = Get-Childitem –Path $(Agent.TempDirectory) -Include *.coverage -Recurse
   
   echo $file.FullName
   
   & "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\Team Tools\Dynamic Code Coverage Tools\CodeCoverage.exe" analyze /output:"$(Agent.TempDirectory)\VisualStudio.coveragexml" $file.FullName
  displayName: 'Convert Code Coverage'

- task: alanwales.resharper-code-analysis.custom-build-task.ResharperCli@1
  displayName: 'R# Analysis'
  inputs:
    SolutionOrProjectPath: Intellias.CQRS/Intellias.CQRS.sln
    CommandLineInterfacePath: '$(Agent.HomeDirectory)/Lib/Resharper'

- task: SonarSource.sonarcloud.ce096e50-6155-4de8-8800-4221aaeed4a1.SonarCloudAnalyze@1
  displayName: 'Sonar Analysis'

- task: SonarSource.sonarcloud.38b27399-a642-40af-bb7d-9971f69712e8.SonarCloudPublish@1
  displayName: 'Publish Quality Gate Result'

